<div class="chat-container">
    <div *ngIf="selectedMessage" class="back-button-container">
        <button (click)="deselectMessage()">← Back</button>
    </div>  
    <div *ngIf="hasMoreMessages" class="load-more-container">
        <button (click)="loadChatMessages(true)">Load More Messages</button>
    </div>
    <ul class="messages-list">
        <li *ngFor="let message of messages | reverse">
            <div (click)="selectMessage(message)">
                <strong>{{ message.IsAnonymous ? 'Anonymous' : message.Sender.UserName }}:</strong> 
                {{ message.ChatMessageText }}
                <div class="message-timestamp">{{ message.ChatMessageDate | date:'short' }}</div>
                <div *ngIf="message.ReplyCount > 0">
                    <span (click)="selectMessage(message); $event.stopPropagation()">{{ message.ReplyCount }} replies</span>
                </div>
                <ul *ngIf="isMessageSelected && selectedMessage === message && selectedMessage?.Replies && selectedMessage?.Replies!.length > 0">
                    <li *ngFor="let reply of selectedMessage?.Replies">
                        <!-- Display each reply's text -->
                        <div>{{ reply.ChatMessageText }}</div>
                        <div class="reply-timestamp">{{ reply.ChatMessageDate | date:'short' }}</div>
                        <!-- Optionally display sender information if needed -->
                        <!-- <div>Sender: {{ reply.Sender.UserName }}</div> -->
                    </li>
                </ul>
                <button *ngIf="!isMessageSelected || (isMessageSelected && selectedMessage?.ChatMessageID === message.ChatMessageID)"
                        (click)="startReplyingTo(message.ChatMessageID); $event.stopPropagation()">Reply</button>
                <div *ngIf="replyingTo === message.ChatMessageID" class="reply-input">
                    <input type="text" [(ngModel)]="replyText" placeholder="Type a reply..." />
                    <label>
                        <input type="checkbox" [(ngModel)]="isAnonymousReply" /> Post Anonymously
                    </label>
                    <button (click)="sendMessage(); $event.stopPropagation()">Send Reply</button>
                    <button (click)="cancelReply(); $event.stopPropagation()">Cancel</button>
                </div>
            </div>
        </li>
    </ul>
    <div class="message-input" *ngIf="!replyingTo && !isMessageSelected">
        <input type="text" [(ngModel)]="newMessageText" placeholder="Type a message..." />
        <label>
            <input type="checkbox" [(ngModel)]="isAnonymous" /> Post Anonymously
        </label>
        <button (click)="sendMessage()">Send</button>
    </div>
</div>
